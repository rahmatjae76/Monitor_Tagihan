<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Tagihan Klien - Supabase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Custom Scrollbar for cleaner look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // --- SETUP SUPABASE ---
        const SUPABASE_URL = 'https://epitfrqwwsdtqvcxxfgo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwaXRmcnF3d3NkdHF2Y3h4ZmdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjM0MTksImV4cCI6MjA3OTgzOTQxOX0.-gccKjikjaFXVCQ9W-uj77OlhbKPfJplb81rrTBTID4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- KONSTANTA & UTILS ---
        const InvoiceStatus = {
            DRAFT: 'DRAFT',
            SUBMITTED: 'Diajukan (Progress)',
            APPROVED: 'Disetujui (Final)',
            PAID: 'Lunas',
            OVERDUE: 'Jatuh Tempo',
            PARTIAL_PAID: 'Bayar Sebagian',
        };

        const formatRupiah = (amount) => {
            if (typeof amount !== 'number' || isNaN(amount)) return 'Rp 0';
            const displayAmount = Math.abs(amount);
            const formatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(displayAmount);
            return amount < 0 ? `(${formatted})` : formatted;
        };

        const calculateAge = (dateString) => {
            if (!dateString) return 'N/A';
            const today = new Date();
            const invoiceDate = new Date(dateString);
            const diffTime = Math.abs(today - invoiceDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        };

        const getDate = (days = 0) => {
            const d = new Date();
            d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        };
        
        const parseAmount = (value) => {
            const num = parseFloat(String(value).replace(/[^0-9]/g, '')) || 0;
            return Math.round(num);
        };

        // --- ICON COMPONENTS (Inline SVG replacement for lucide-react) ---
        const Icons = {
            CreditCard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            Loader: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            AlertTriangle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            DollarSign: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Briefcase: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            ChevronDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>,
            Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Link: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            List: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            MinusCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" x2="16" y1="12" y2="12"/></svg>,
            LogIn: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>,
            WifiOff: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" x2="23" y1="1" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>
        };


        // --- MOCK DATA GENERATORS ---
        const getMockClients = () => [
            {
                id: 'C-001', name: 'PT. Teknologi Maju',
                projects: [{ id: 'P-001', name: 'Implementasi Sistem CRM', activities: [{ id: 'A-001', name: 'Fase Analisis Kebutuhan' }, { id: 'A-002', name: 'Fase Pengembangan dan Uji Coba' }] }, { id: 'P-002', name: 'Audit Keamanan Jaringan', activities: [{ id: 'A-003', name: 'Pengetesan Penetration' }] }]
            },
            {
                id: 'C-002', name: 'CV. Kreatif Solusi',
                projects: [{ id: 'P-003', name: 'Penyusunan Konten Digital', activities: [{ id: 'A-004', name: 'Campaign Media Sosial Q4' }] }]
            }
        ];

        const getMockInvoices = () => [
            {
                id: 'INV-PROG-001', invoiceType: 'PROGRESS', status: InvoiceStatus.SUBMITTED,
                clientId: 'C-001', clientName: 'PT. Teknologi Maju', projectId: 'P-001', projectName: 'Implementasi Sistem CRM',
                activityId: 'A-001', activityName: 'Fase Analisis Kebutuhan', description: 'Klaim Progres Fase Analisis Kebutuhan (80% selesai).',
                invoiceDate: getDate(-7), dueDate: getDate(23), totalAmountExclPPN: 50000000, amountReceived: 0,
                documentLink: '', history: [{ note: "Klaim progres diajukan.", date: new Date().toLocaleString('id-ID'), user: 'System' }], paymentHistory: []
            },
            {
                id: 'INV-FINAL-002', invoiceType: 'FINAL', status: InvoiceStatus.APPROVED, invoiceNumber: 'FIN/2025/11/002',
                clientId: 'C-001', clientName: 'PT. Teknologi Maju', projectId: 'P-002', projectName: 'Audit Keamanan Jaringan',
                activityId: 'A-003', activityName: 'Pengetesan Penetration', description: 'Invoice Final Jasa Audit Keamanan.',
                invoiceDate: getDate(-45), dueDate: getDate(-10), totalAmountExclPPN: 30000000, amountReceived: 0,
                documentLink: 'https://docs.google.com/document/d/invoice-002-audit',
                history: [{ note: "Invoice Final dikirim.", date: new Date().toLocaleString('id-ID'), user: 'Finance' }], paymentHistory: []
            }
        ];

        // --- UI COMPONENTS ---

        const PaymentModal = ({ isOpen, invoice, onUpdate, onCancel }) => {
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]); 
            const [cashReceivedInput, setCashReceivedInput] = React.useState('');
            const [pphDeductionInput, setPphDeductionInput] = React.useState('');
            const [adjustmentInput, setAdjustmentInput] = React.useState('');
            const [note, setNote] = React.useState('');
            const [adjustmentNote, setAdjustmentNote] = React.useState('');
            
            const currentInvoice = invoice;
            const totalAmount = currentInvoice ? Math.round(currentInvoice.totalAmountExclPPN || 0) : 0;
            const currentApplied = currentInvoice ? Math.round(currentInvoice.amountReceived || 0) : 0;
            const totalOutstanding = totalAmount - currentApplied;

            const cashReceived = parseAmount(cashReceivedInput);
            const pphDeduction = parseAmount(pphDeductionInput);
            const adjustment = parseAmount(adjustmentInput);
            const totalAppliedThisTx = cashReceived + pphDeduction + adjustment;
            const projectedOutstanding = totalAmount - (currentApplied + totalAppliedThisTx);

            React.useEffect(() => {
                if (isOpen && currentInvoice) {
                    setNote(''); setAdjustmentNote(''); setCashReceivedInput('');
                    setPphDeductionInput(''); setAdjustmentInput('');
                    setDate(new Date().toISOString().split('T')[0]);
                }
            }, [isOpen, currentInvoice]);
            
            if (!isOpen || !currentInvoice) return null;

            const handleSubmit = () => {
                if (totalAppliedThisTx > totalOutstanding) {
                    alert("Total pembayaran melebihi sisa tagihan!");
                    return;
                }
                onUpdate(currentInvoice.id, {
                    date, cashReceived, pphDeduction, adjustmentAmount: adjustment, note, adjustmentNote,
                });
            };
            
            const formatAmountDisplay = (val) => {
                const num = parseAmount(val);
                return isNaN(num) || num === 0 ? '' : new Intl.NumberFormat('id-ID').format(num);
            };

            const isSubmitDisabled = totalAppliedThisTx <= 0 || !note.trim() || (adjustment !== 0 && !adjustmentNote.trim()) || totalAppliedThisTx > totalOutstanding;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-xl transform transition-all duration-300 overflow-hidden">
                        <div className="p-6 max-h-[90vh] overflow-y-auto">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 className="text-xl font-bold text-gray-900 flex items-center"><Icons.DollarSign className="w-5 h-5 mr-2"/> Catat Pembayaran</h3>
                                <button onClick={onCancel} className="p-1 rounded-full hover:bg-gray-100"><Icons.X className="w-5 h-5 text-gray-500"/></button>
                            </div>
                            
                            <p className="text-sm text-gray-600 mb-4">Invoice: <span className="font-semibold">{currentInvoice.clientName}</span></p>

                            <div className="space-y-4 mb-4 p-4 bg-indigo-50 rounded-lg">
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-2">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700">1. Kas Diterima</label>
                                        <input type="text" value={formatAmountDisplay(cashReceivedInput)} onChange={(e) => setCashReceivedInput(e.target.value.replace(/[^0-9]/g, ''))} className="mt-1 block w-full p-2 border rounded text-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700">2. PPh</label>
                                        <input type="text" value={formatAmountDisplay(pphDeductionInput)} onChange={(e) => setPphDeductionInput(e.target.value.replace(/[^0-9]/g, ''))} className="mt-1 block w-full p-2 border rounded text-sm"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700">3. Selisih</label>
                                        <input type="text" value={formatAmountDisplay(adjustmentInput)} onChange={(e) => setAdjustmentInput(e.target.value.replace(/[^0-9]/g, ''))} className="mt-1 block w-full p-2 border rounded text-sm"/>
                                    </div>
                                </div>
                                {adjustment !== 0 && (
                                    <input type="text" value={adjustmentNote} onChange={(e) => setAdjustmentNote(e.target.value)} placeholder="Catatan Selisih (Wajib)" className="w-full p-2 text-sm border rounded"/>
                                )}
                                <div className="pt-2 border-t border-indigo-200 text-sm">
                                    <div className="flex justify-between font-bold text-red-600"><span>Sisa Saat Ini:</span><span>{formatRupiah(totalOutstanding)}</span></div>
                                    <div className="flex justify-between font-bold text-indigo-600"><span>Total Diterapkan:</span><span>{formatRupiah(totalAppliedThisTx)}</span></div>
                                    <div className="flex justify-between font-bold text-gray-800"><span>Sisa Akhir (Proyeksi):</span><span>{formatRupiah(projectedOutstanding)}</span></div>
                                </div>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="block text-sm font-medium">Tanggal</label>
                                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-2 border rounded text-sm"/>
                                <label className="block text-sm font-medium">Catatan Histori</label>
                                <textarea value={note} onChange={(e) => setNote(e.target.value)} rows="2" className="w-full p-2 border rounded text-sm"></textarea>
                            </div>

                            <div className="flex justify-end space-x-3 mt-6">
                                <button onClick={onCancel} className="px-4 py-2 text-sm bg-gray-100 rounded">Batal</button>
                                <button onClick={handleSubmit} disabled={isSubmitDisabled} className="px-4 py-2 text-sm text-white bg-indigo-600 rounded disabled:opacity-50">Simpan</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [invoices, setInvoices] = React.useState([]);
            const [clients, setClients] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [activeView, setActiveView] = React.useState('DASHBOARD');
            const [selectedInvoice, setSelectedInvoice] = React.useState(null);
            const [filterClient, setFilterClient] = React.useState('');
            const [filterProject, setFilterProject] = React.useState('');
            
            const [isPaymentModalOpen, setIsPaymentModalOpen] = React.useState(false);
            const [modalContext, setModalContext] = React.useState(null);
            const [errorMsg, setErrorMsg] = React.useState(null);
            const [isDemoMode, setIsDemoMode] = React.useState(false);

            // Fetch Data from Supabase
            const fetchData = async () => {
                setLoading(true);
                let usingMock = false;
                try {
                    // 1. Try Fetch Clients
                    let { data: clientsData, error: errClients } = await supabase.from('clients').select('*');
                    
                    if (errClients) {
                        console.warn("Error fetching clients (likely table missing), switching to mock:", errClients);
                        setClients(getMockClients());
                        usingMock = true;
                    } else if (!clientsData || clientsData.length === 0) {
                        // Table exists but empty, try to seed
                        const mocks = getMockClients();
                        const { error: seedError } = await supabase.from('clients').insert(mocks.map(c => ({ id: c.id, data: c })));
                        if (seedError) {
                             console.warn("Seeding failed, using local mock:", seedError);
                             setClients(mocks);
                             usingMock = true;
                        } else {
                             setClients(mocks);
                        }
                    } else {
                        setClients(clientsData.map(row => row.data));
                    }

                    // 2. Fetch Invoices
                    let { data: invData, error: errInv } = await supabase.from('invoices').select('*');
                    
                    if (errInv) {
                        console.warn("Error fetching invoices, switching to mock:", errInv);
                        setInvoices(getMockInvoices());
                        usingMock = true;
                    } else if (!invData || invData.length === 0) {
                        const mocks = getMockInvoices();
                         const { error: seedError } = await supabase.from('invoices').insert(mocks.map(i => ({ id: i.id, data: i })));
                         if (seedError) {
                             setInvoices(mocks);
                             usingMock = true;
                         } else {
                             setInvoices(mocks);
                         }
                    } else {
                        setInvoices(invData.map(row => row.data));
                    }

                    if (usingMock) {
                        setIsDemoMode(true);
                    }

                } catch (err) {
                    console.error("Unexpected error, falling back to mocks:", err);
                    setClients(getMockClients());
                    setInvoices(getMockInvoices());
                    setIsDemoMode(true);
                } finally {
                    setLoading(false);
                }
            };

            React.useEffect(() => {
                fetchData();
            }, []);

            // Update Logic
            const handleUpdate = async (id, payload) => {
                const invoice = invoices.find(i => i.id === id);
                if (!invoice) return;

                let updatedData = { ...invoice };
                
                // Handle Payment
                if (payload.cashReceived !== undefined) {
                    const paymentTx = {
                        id: Date.now().toString(),
                        ...payload,
                        appliedAmount: payload.cashReceived + payload.pphDeduction + payload.adjustmentAmount,
                        processedBy: 'Admin'
                    };
                    
                    const prevHistory = invoice.paymentHistory || [];
                    const newPaymentHistory = [...prevHistory, paymentTx];
                    const totalReceived = newPaymentHistory.reduce((sum, tx) => sum + tx.appliedAmount, 0);
                    const outstanding = invoice.totalAmountExclPPN - totalReceived;

                    updatedData.paymentHistory = newPaymentHistory;
                    updatedData.amountReceived = totalReceived;
                    updatedData.status = outstanding <= 0 ? InvoiceStatus.PAID : InvoiceStatus.PARTIAL_PAID;
                    
                    // Add to history log
                    updatedData.history.push({ note: `Pembayaran dicatat: ${formatRupiah(paymentTx.appliedAmount)}`, date: new Date().toLocaleString(), user: 'Admin' });
                } 
                // Handle Status Update / Edit
                else {
                   updatedData = { ...updatedData, ...payload };
                   if (payload.note) {
                       updatedData.history.push({ note: payload.note, date: new Date().toLocaleString(), user: 'Admin' });
                   }
                }

                // Optimistic Update (Update Local State First)
                setInvoices(prev => prev.map(i => i.id === id ? updatedData : i));
                if (selectedInvoice && selectedInvoice.id === id) setSelectedInvoice(updatedData);
                setIsPaymentModalOpen(false);

                // Try Supabase Update (JSONB update) if not in demo mode
                if (!isDemoMode) {
                    const { error } = await supabase.from('invoices').update({ data: updatedData }).eq('id', id);
                    if (error) {
                        console.warn("Gagal menyimpan ke Supabase (Mungkin tabel tidak ada), data lokal tetap diupdate.", error);
                        // No alert needed, keeps UX smooth
                    }
                }
            };

            // --- VIEW HELPERS ---
            const filteredInvoices = React.useMemo(() => {
                return invoices.filter(inv => {
                    if (filterClient && inv.clientId !== filterClient) return false;
                    const outstanding = inv.totalAmountExclPPN - inv.amountReceived;
                    const isOverdue = inv.status !== 'Lunas' && new Date(inv.dueDate) < new Date();
                    inv.isOverdue = isOverdue;
                    inv.outstandingBalance = outstanding;
                    
                    const isFinalOutstanding = inv.invoiceType === 'FINAL' && inv.status !== InvoiceStatus.PAID;
                    const isProgress = inv.invoiceType === 'PROGRESS';
                    return isFinalOutstanding || isProgress;
                }).sort((a, b) => new Date(b.invoiceDate) - new Date(a.invoiceDate));
            }, [invoices, filterClient]);

            const stats = React.useMemo(() => {
                const finals = filteredInvoices.filter(i => i.invoiceType === 'FINAL');
                const progress = filteredInvoices.filter(i => i.invoiceType === 'PROGRESS');
                return {
                    outstanding: finals.reduce((acc, curr) => acc + curr.outstandingBalance, 0),
                    progress: progress.reduce((acc, curr) => acc + curr.totalAmountExclPPN, 0),
                    overdue: finals.filter(i => i.isOverdue).length
                };
            }, [filteredInvoices]);


            if (loading) return <div className="h-screen flex items-center justify-center"><Icons.Loader className="animate-spin w-10 h-10 text-indigo-600"/></div>;

            return (
                <div className="max-w-5xl mx-auto p-4 pb-20">
                    {/* HEADER */}
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-xl font-bold text-gray-800 flex items-center">
                           <Icons.CreditCard className="w-6 h-6 mr-2 text-indigo-600"/> Monitor Tagihan
                        </h1>
                        {isDemoMode ? 
                            <div className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded border border-yellow-200 font-bold">Mode Demo (Lokal)</div> :
                            <div className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded border border-green-200">Online</div>
                        }
                    </div>

                    {/* MAIN CONTENT */}
                    {activeView === 'DASHBOARD' ? (
                        <div className="space-y-4">
                            {/* SUMMARY CARDS */}
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div className="bg-white p-3 rounded-xl shadow border-b-4 border-indigo-500" onClick={() => document.getElementById('final-table').scrollIntoView()}>
                                    <p className="text-[10px] font-bold text-gray-500 uppercase">Total Outstanding</p>
                                    <p className="text-lg font-extrabold text-gray-800 truncate">{formatRupiah(stats.outstanding)}</p>
                                </div>
                                <div className="bg-white p-3 rounded-xl shadow border-b-4 border-yellow-500">
                                    <p className="text-[10px] font-bold text-gray-500 uppercase">Progress Claim</p>
                                    <p className="text-lg font-extrabold text-gray-800 truncate">{formatRupiah(stats.progress)}</p>
                                </div>
                                <div className="bg-white p-3 rounded-xl shadow border-b-4 border-red-500">
                                    <p className="text-[10px] font-bold text-gray-500 uppercase">Overdue</p>
                                    <p className="text-lg font-extrabold text-red-600">{stats.overdue} Inv</p>
                                </div>
                            </div>

                            {/* FILTER */}
                            <select className="w-full p-2 text-sm border rounded-lg" value={filterClient} onChange={e => setFilterClient(e.target.value)}>
                                <option value="">Semua Klien</option>
                                {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>

                            {/* TABLES */}
                            <div id="final-table" className="bg-white rounded-xl shadow overflow-hidden">
                                <div className="p-3 border-b bg-gray-50 text-sm font-bold text-gray-700">Outstanding Final</div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-xs">
                                        <thead className="bg-gray-100 text-gray-500"><tr><th className="p-2">Invoice</th><th className="p-2">Klien</th><th className="p-2 text-right">Sisa</th></tr></thead>
                                        <tbody className="divide-y">
                                            {filteredInvoices.filter(i => i.invoiceType === 'FINAL').map(inv => (
                                                <tr key={inv.id} onClick={() => { setSelectedInvoice(inv); setActiveView('DETAIL'); }} className="hover:bg-indigo-50 cursor-pointer">
                                                    <td className="p-2 font-medium">{inv.invoiceNumber}<br/><span className={inv.isOverdue ? 'text-red-500' : 'text-gray-500'}>{new Date(inv.dueDate).toLocaleDateString('id-ID')}</span></td>
                                                    <td className="p-2 truncate max-w-[120px]">{inv.clientName}</td>
                                                    <td className="p-2 text-right font-bold text-indigo-600">{formatRupiah(inv.outstandingBalance)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    ) : (
                        // DETAIL VIEW
                        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                             <div className="p-4 border-b flex justify-between items-start bg-gray-50">
                                <div>
                                    <h2 className="text-lg font-bold">{selectedInvoice.invoiceNumber || 'Draft'}</h2>
                                    <span className={`text-xs px-2 py-0.5 rounded ${selectedInvoice.status === InvoiceStatus.PAID ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{selectedInvoice.status}</span>
                                </div>
                                <button onClick={() => setActiveView('DASHBOARD')} className="p-1 bg-gray-200 rounded-full"><Icons.X className="w-5 h-5"/></button>
                            </div>
                            
                            <div className="p-4 space-y-6">
                                {/* Financials */}
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 bg-indigo-50 rounded-lg">
                                    <div><p className="text-xs text-gray-500">Total Tagihan</p><p className="font-bold">{formatRupiah(selectedInvoice.totalAmountExclPPN)}</p></div>
                                    <div><p className="text-xs text-gray-500">Sudah Diterima</p><p className="font-bold text-green-600">{formatRupiah(selectedInvoice.amountReceived)}</p></div>
                                    <div><p className="text-xs text-gray-500">Sisa</p><p className="font-bold text-red-600">{formatRupiah(selectedInvoice.totalAmountExclPPN - selectedInvoice.amountReceived)}</p></div>
                                </div>

                                {/* Info Form */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div><label className="block text-xs text-gray-500">Klien</label><div className="font-medium">{selectedInvoice.clientName}</div></div>
                                    <div><label className="block text-xs text-gray-500">Proyek</label><div className="font-medium">{selectedInvoice.projectName}</div></div>
                                    <div><label className="block text-xs text-gray-500">Tanggal</label><input type="date" className="w-full border p-1 rounded" defaultValue={selectedInvoice.invoiceDate} onChange={(e) => handleUpdate(selectedInvoice.id, { invoiceDate: e.target.value })} /></div>
                                    {selectedInvoice.invoiceType === 'FINAL' && (
                                         <div><label className="block text-xs text-gray-500">Link Dokumen</label>
                                            <div className="flex space-x-2">
                                                <input type="text" className="flex-1 border p-1 rounded" defaultValue={selectedInvoice.documentLink} onBlur={(e) => handleUpdate(selectedInvoice.id, { documentLink: e.target.value })} placeholder="http://" />
                                                {selectedInvoice.documentLink && <a href={selectedInvoice.documentLink} target="_blank" className="p-1 bg-blue-100 text-blue-600 rounded"><Icons.Link className="w-4 h-4"/></a>}
                                            </div>
                                         </div>
                                    )}
                                    <div className="md:col-span-2"><label className="block text-xs text-gray-500">Deskripsi</label><textarea className="w-full border p-2 rounded" rows="3" defaultValue={selectedInvoice.description} onBlur={(e) => handleUpdate(selectedInvoice.id, { description: e.target.value })}></textarea></div>
                                </div>

                                {/* Actions */}
                                <div className="flex flex-wrap gap-2 pt-4 border-t">
                                    {selectedInvoice.invoiceType === 'FINAL' && (selectedInvoice.totalAmountExclPPN - selectedInvoice.amountReceived > 0) && (
                                        <button onClick={() => { setModalContext({ invoice: selectedInvoice, action: 'PAYMENT' }); setIsPaymentModalOpen(true); }} className="flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 shadow">
                                            <Icons.DollarSign className="w-4 h-4 mr-2"/> Catat Pembayaran
                                        </button>
                                    )}
                                    {selectedInvoice.invoiceType === 'PROGRESS' && selectedInvoice.status === InvoiceStatus.SUBMITTED && (
                                        <button onClick={() => handleUpdate(selectedInvoice.id, { status: InvoiceStatus.APPROVED, note: 'Status updated to Final' })} className="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 shadow">
                                            <Icons.CheckCircle className="w-4 h-4 mr-2"/> Ubah ke Final
                                        </button>
                                    )}
                                </div>
                                
                                {/* Payment History */}
                                {selectedInvoice.paymentHistory && selectedInvoice.paymentHistory.length > 0 && (
                                    <div className="mt-4">
                                        <h4 className="font-bold text-sm flex items-center mb-2"><Icons.List className="w-4 h-4 mr-2"/> Riwayat Pembayaran</h4>
                                        <div className="bg-gray-50 rounded-lg p-2 max-h-40 overflow-y-auto text-xs space-y-2">
                                            {selectedInvoice.paymentHistory.map((pay, idx) => (
                                                <div key={idx} className="border-b pb-2 last:border-0">
                                                    <div className="flex justify-between font-bold text-green-700">
                                                        <span>+{formatRupiah(pay.appliedAmount)}</span>
                                                        <span className="text-gray-500 font-normal">{new Date(pay.date).toLocaleDateString('id-ID')}</span>
                                                    </div>
                                                    <div className="text-gray-600">Cash: {formatRupiah(pay.cashReceived)} | PPh: {formatRupiah(pay.pphDeduction)}</div>
                                                    {pay.note && <div className="text-gray-500 italic">"{pay.note}"</div>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* MODAL */}
                    <PaymentModal 
                        isOpen={isPaymentModalOpen} 
                        invoice={modalContext?.invoice} 
                        onUpdate={handleUpdate}
                        onCancel={() => setIsPaymentModalOpen(false)}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
