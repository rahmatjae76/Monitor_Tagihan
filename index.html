<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitor Tagihan Piutang - Supabase Demo</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .spinner { border: 3px solid rgba(0,0,0,0.08); border-top: 3px solid rgba(59,130,246,1); border-radius:50%; width:18px; height:18px; animation:spin 1s linear infinite; display:inline-block }
    @keyframes spin { to { transform: rotate(360deg) } }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    /* Simple modal backdrop transition */
    .modal-backdrop { background: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen antialiased">
  <div id="root" class="p-4 sm:p-8"></div>

  <!-- React & ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Supabase client: create and attach to window.supabaseClient (module) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://epitfrqwwsdtqvcxxfgo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwaXRmcnF3d3NkdHF2Y3h4ZmdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjM0MTksImV4cCI6MjA3OTgzOTQxOX0.-gccKjikjaFXVCQ9W-uj77OlhbKPfJplb81rrTBTID4';

    try {
      window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 10 } } });
      console.log('Supabase client initialized');
    } catch (e) {
      console.error('Supabase init failed', e);
      window.supabaseClient = null;
    }
  </script>

  <!-- Babel to compile JSX in browser for demo purposes -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Main app -->
  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useMemo, useCallback } = React;

    // Helpers
    const formatRupiah = (n) => {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits:0 }).format(Number(n || 0));
    };
    const todayISO = () => new Date().toISOString().slice(0,10);
    const daysUntil = (dateStr) => {
      if (!dateStr) return Infinity;
      const due = new Date(dateStr); due.setHours(0,0,0,0);
      const now = new Date(); now.setHours(0,0,0,0);
      return Math.ceil((due - now) / (1000*60*60*24));
    };
    const uid = () => Math.random().toString(36).slice(2,9) + Date.now();

    // Mock data (used when Supabase unavailable)
    const MOCK_DATA = (() => {
      const past = d => new Date(Date.now() - d*24*60*60*1000).toISOString().slice(0,10);
      return [
        {
          id: 'd1',
          proyek: 'Renovasi Kantor Pusat',
          klien: 'PT. Mega Karya',
          tipe: 'Invoice Final',
          nominal: 150000000,
          tanggal: past(40),
          dueDate: past(10),
          amountPaid: 0,
          keterangan: 'Pelunasan Tahap 2 (Final)',
          statusPembayaran: 'Jatuh Tempo',
          history: [
            { id: uid(), date: past(40), note: 'Invoice dibuat', action: 'CREATE' },
            { id: uid(), date: past(38), note: 'Dikirim via email', action: 'SEND' },
          ],
        },
        {
          id: 'd2',
          proyek: 'Sistem IT Baru',
          klien: 'PT. Solusi Digital',
          tipe: 'Klaim Progres',
          nominal: 50000000,
          tanggal: past(60),
          dueDate: null,
          amountPaid: 50000000,
          keterangan: 'Klaim 30% pembayaran awal',
          statusPembayaran: 'Lunas',
          history: [
            { id: uid(), date: past(60), note: 'Klaim dibuat', action: 'CREATE' },
            { id: uid(), date: past(50), note: 'Pembayaran diterima', action: 'PAYMENT_RECEIVED' },
          ],
        },
        {
          id: 'd3',
          proyek: 'Pembangunan Gudang C',
          klien: 'CV. Bangun Abadi',
          tipe: 'Invoice Final',
          nominal: 85000000,
          tanggal: past(20),
          dueDate: (() => { const dt = new Date(); dt.setDate(dt.getDate()+5); return dt.toISOString().slice(0,10); })(),
          amountPaid: 40000000,
          keterangan: 'Pelunasan Tagihan Material Dasar',
          statusPembayaran: 'Outstanding',
          history: [
            { id: uid(), date: past(20), note: 'Invoice awal', action: 'CREATE' },
            { id: uid(), date: past(10), note: 'Pembayaran parsial Rp40jt', action: 'PARTIAL_PAYMENT' },
          ],
        },
      ];
    })();

    // Small Icon component (emoji)
    const Icon = ({ children }) => <span style={{fontSize:16}}>{children}</span>;

    function App() {
      const sb = window.supabaseClient || null;
      const table = 'transaksi';

      const [transactions, setTransactions] = useState([]);
      const [loading, setLoading] = useState(false);
      const [useMock, setUseMock] = useState(false);
      const [error, setError] = useState(null);

      // UI state
      const [clientFilter, setClientFilter] = useState('');
      const [projectFilter, setProjectFilter] = useState('');
      const [activityFilter, setActivityFilter] = useState('');
      const [search, setSearch] = useState('');
      const [activeView, setActiveView] = useState('dashboard'); // dashboard | detail
      const [detailItem, setDetailItem] = useState(null);

      // Form modal state
      const [formOpen, setFormOpen] = useState(false);
      const [formData, setFormData] = useState(null);
      // history modal
      const [historyFormOpen, setHistoryFormOpen] = useState(false);
      const [historyDraft, setHistoryDraft] = useState({ action: 'NOTE', note: '' });
      // confirmation modal
      const [confirm, setConfirm] = useState(null);

      // Fetch transactions from Supabase or fallback
      const fetchTransactions = useCallback(async () => {
        if (!sb) {
          setTransactions(MOCK_DATA);
          setUseMock(true);
          return;
        }
        setLoading(true);
        setError(null);
        try {
          const { data, error: err } = await sb.from(table).select('*').order('tanggal', { ascending: false });
          if (err) throw err;
          const normalized = (data||[]).map(r => ({
            id: r.id,
            proyek: r.proyek,
            klien: r.klien,
            tipe: r.tipe,
            nominal: Number(r.nominal || 0),
            tanggal: r.tanggal ? (new Date(r.tanggal)).toISOString().slice(0,10) : '',
            dueDate: r.duedate ? (new Date(r.duedate)).toISOString().slice(0,10) : null,
            amountPaid: Number(r.amountpaid || 0),
            keterangan: r.keterangan,
            statusPembayaran: r.statuspembayaran || ((Number(r.nominal||0) - Number(r.amountpaid||0)) <=0 ? 'Lunas' : 'Outstanding'),
            history: Array.isArray(r.history) ? r.history : (r.history ? JSON.parse(r.history) : []),
          }));
          setTransactions(normalized);
          setUseMock(false);
        } catch (e) {
          console.error(e);
          setError('Gagal memuat data dari Supabase. Menggunakan data mock.');
          setTransactions(MOCK_DATA);
          setUseMock(true);
        } finally {
          setLoading(false);
        }
      }, [sb]);

      // Realtime subscription
      useEffect(() => {
        let channel = null;
        fetchTransactions();
        if (!sb) return;
        try {
          channel = sb.channel('public:'+table)
            .on('postgres_changes', { event: '*', schema: 'public', table }, payload => {
              // simply re-fetch for simplicity
              fetchTransactions();
            })
            .subscribe();
        } catch (e) {
          console.warn('Realtime not available', e);
        }
        return () => {
          if (channel && sb) {
            try { sb.removeChannel(channel); } catch(e) {}
          }
        };
      }, [sb, fetchTransactions]);

      // Derived filters (from transactions)
      const clients = useMemo(() => Array.from(new Set(transactions.map(t => t.klien))).sort(), [transactions]);
      const projects = useMemo(() => {
        const list = transactions.filter(t => !clientFilter || t.klien === clientFilter).map(t => t.proyek);
        return Array.from(new Set(list)).sort();
      }, [transactions, clientFilter]);
      const activities = useMemo(() => {
        const list = transactions
          .filter(t => (!clientFilter || t.klien === clientFilter) && (!projectFilter || t.proyek === projectFilter))
          .map(t => t.keterangan);
        return Array.from(new Set(list)).sort();
      }, [transactions, clientFilter, projectFilter]);

      // Filtered sets for two tables
      const invoiceFinal = useMemo(() => transactions.filter(t =>
        t.tipe === 'Invoice Final' &&
        (!clientFilter || t.klien === clientFilter) &&
        (!projectFilter || t.proyek === projectFilter) &&
        (!activityFilter || t.keterangan === activityFilter) &&
        (search === '' || [t.proyek,t.klien,t.keterangan].join(' ').toLowerCase().includes(search.toLowerCase()))
      ), [transactions, clientFilter, projectFilter, activityFilter, search]);

      const klaimProgres = useMemo(() => transactions.filter(t =>
        t.tipe === 'Klaim Progres' &&
        (!clientFilter || t.klien === clientFilter) &&
        (!projectFilter || t.proyek === projectFilter) &&
        (!activityFilter || t.keterangan === activityFilter) &&
        (search === '' || [t.proyek,t.klien,t.keterangan].join(' ').toLowerCase().includes(search.toLowerCase()))
      ), [transactions, clientFilter, projectFilter, activityFilter, search]);

      // Dashboard summary
      const summary = useMemo(() => {
        const totalOutstanding = transactions.reduce((s,t) => s + Math.max(0, t.nominal - (t.amountPaid||0)), 0);
        const totalKlaim = transactions.filter(t => t.tipe==='Klaim Progres').reduce((s,t)=>s+t.nominal,0);
        const totalInvoice = transactions.filter(t => t.tipe==='Invoice Final').reduce((s,t)=>s+t.nominal,0);
        return { totalOutstanding, totalKlaim, totalInvoice };
      }, [transactions]);

      // Open detail modal (or navigate)
      const openDetail = (item) => {
        setDetailItem(item);
        setActiveView('detail');
      };

      // Toggle form for create/edit transaction (simple)
      const openForm = (item=null) => {
        setFormData(item ? { ...item } : {
          id: null, proyek:'', klien:'', tipe:'Invoice Final', nominal:0, tanggal: todayISO(), dueDate:'', amountPaid:0, keterangan:'', statusPembayaran:'Outstanding', history: []
        });
        setFormOpen(true);
      };

      // Save transaksi (insert or update)
      const saveTransaksi = async (payload) => {
        if (!sb) {
          // local mock save
          if (payload.id) {
            setTransactions(prev => prev.map(p => p.id === payload.id ? payload : p));
          } else {
            payload.id = 'm_'+uid();
            setTransactions(prev => [payload, ...prev]);
          }
          setFormOpen(false);
          return;
        }
        setLoading(true);
        try {
          const record = {
            proyek: payload.proyek, klien: payload.klien, tipe: payload.tipe,
            nominal: payload.nominal, tanggal: payload.tanggal || null,
            duedate: payload.dueDate || null, amountpaid: payload.amountPaid || 0,
            keterangan: payload.keterangan, statuspembayaran: payload.statusPembayaran,
            history: payload.history || []
          };
          if (payload.id) {
            const { error } = await sb.from(table).update(record).eq('id', payload.id);
            if (error) throw error;
          } else {
            const { error } = await sb.from(table).insert(record);
            if (error) throw error;
          }
          await fetchTransactions();
          setFormOpen(false);
        } catch (e) {
          console.error(e);
          setError('Gagal menyimpan transaksi: '+(e.message||e));
        } finally {
          setLoading(false);
        }
      };

      // Change status with confirmation
      const requestStatusChange = (item, newStatus, forceTypeConvert=false) => {
        const message = forceTypeConvert
          ? `Ubah tipe dokumen menjadi 'Invoice Final' dan set status menjadi '${newStatus}' untuk ${item.proyek}? Anda akan diminta konfirmasi.`
          : `Ubah status menjadi '${newStatus}' untuk ${item.proyek}?`;
        setConfirm({
          title: 'Konfirmasi Perubahan Status',
          message,
          onConfirm: async () => {
            setConfirm(null);
            await performStatusChange(item, newStatus, forceTypeConvert);
          },
          onCancel: () => setConfirm(null)
        });
      };

      const performStatusChange = async (item, newStatus, convertType=false) => {
        if (!sb) {
          const updated = { ...item, statusPembayaran: newStatus };
          if (convertType) updated.tipe = 'Invoice Final';
          setTransactions(prev => prev.map(p => p.id === item.id ? updated : p));
          if (detailItem && detailItem.id === item.id) setDetailItem(updated);
          return;
        }
        setLoading(true);
        try {
          const updates = { statuspembayaran: newStatus };
          if (convertType) updates.tipe = 'Invoice Final';
          const { error } = await sb.from(table).update(updates).eq('id', item.id);
          if (error) throw error;
          await fetchTransactions();
        } catch (e) {
          console.error(e);
          setError('Gagal memperbarui status: '+(e.message||e));
        } finally {
          setLoading(false);
        }
      };

      // Add/edit history note
      const openHistoryModal = (baseItem, edit=null) => {
        setDetailItem(baseItem);
        setHistoryDraft(edit ? { action: edit.action, note: edit.note, id: edit.id } : { action: 'NOTE', note: '' });
        setHistoryFormOpen(true);
      };

      const saveHistory = async () => {
        if (!detailItem) return;
        if (!historyDraft.note.trim()) { setError('Catatan tidak boleh kosong'); return; }
        const newHistory = {
          id: historyDraft.id || uid(),
          date: new Date().toISOString(),
          note: historyDraft.note.trim(),
          action: historyDraft.action
        };
        const updatedHistory = historyDraft.id
          ? (detailItem.history || []).map(h => h.id === historyDraft.id ? newHistory : h)
          : [...(detailItem.history || []), newHistory];

        if (!sb) {
          const updated = { ...detailItem, history: updatedHistory };
          setTransactions(prev => prev.map(p => p.id === detailItem.id ? updated : p));
          setDetailItem(updated);
          setHistoryFormOpen(false);
          return;
        }
        setLoading(true);
        try {
          const { error } = await sb.from(table).update({ history: updatedHistory }).eq('id', detailItem.id);
          if (error) throw error;
          await fetchTransactions();
          // refresh detail from transactions
          const refreshed = (await sb.from(table).select('*').eq('id', detailItem.id)).data?.[0];
          if (refreshed) {
            const norm = {
              id: refreshed.id,
              proyek: refreshed.proyek,
              klien: refreshed.klien,
              tipe: refreshed.tipe,
              nominal: Number(refreshed.nominal||0),
              tanggal: refreshed.tanggal ? (new Date(refreshed.tanggal)).toISOString().slice(0,10) : '',
              dueDate: refreshed.duedate ? (new Date(refreshed.duedate)).toISOString().slice(0,10) : null,
              amountPaid: Number(refreshed.amountpaid||0),
              keterangan: refreshed.keterangan,
              statusPembayaran: refreshed.statuspembayaran,
              history: Array.isArray(refreshed.history)?refreshed.history:[],
            };
            setDetailItem(norm);
          }
          setHistoryFormOpen(false);
        } catch(e) {
          console.error(e);
          setError('Gagal menyimpan histori: '+(e.message||e));
        } finally {
          setLoading(false);
        }
      };

      // Delete transaction
      const deleteTx = async (id) => {
        if (!sb) {
          setTransactions(prev => prev.filter(p => p.id !== id));
          if (detailItem?.id === id) { setActiveView('dashboard'); setDetailItem(null); }
          return;
        }
        setLoading(true);
        try {
          const { error } = await sb.from(table).delete().eq('id', id);
          if (error) throw error;
          await fetchTransactions();
          if (detailItem?.id === id) { setActiveView('dashboard'); setDetailItem(null); }
        } catch(e) {
          console.error(e); setError('Gagal menghapus: '+(e.message||e));
        } finally { setLoading(false); }
      };

      // Derived grouped outstanding per project for left card
      const outstandingPerProject = useMemo(() => {
        const map = {};
        transactions.forEach(t => {
          const remaining = Math.max(0, t.nominal - (t.amountPaid||0));
          if (remaining <= 0) return;
          const key = `${t.proyek}||${t.keterangan}`;
          if (!map[key]) map[key] = { proyek: t.proyek, keterangan: t.keterangan, totalOutstanding: 0 };
          map[key].totalOutstanding += remaining;
        });
        return Object.values(map).sort((a,b)=> b.totalOutstanding - a.totalOutstanding);
      }, [transactions]);

      // UI components
      return (
        <div>
          <header className="mb-6">
            <h1 className="text-2xl font-bold text-slate-900 flex items-center">
              <span className="mr-2 text-2xl">ðŸ§¾</span>
              Monitor Tagihan Piutang - Supabase
            </h1>
            <p className="text-sm text-slate-600 mt-1">Project: epitfrqwwsdtqvcxxfgo.supabase.co {useMock && <span className="ml-3 text-amber-600">[Mock Mode]</span>}</p>
          </header>

          <main>
            {/* Dashboard Header: summary cards */}
            <section className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="text-sm text-slate-500">Total Outstanding</div>
                <div className="text-xl font-bold mt-2">{formatRupiah(summary.totalOutstanding)}</div>
                <div className="text-xs text-slate-400 mt-1">Sisa belum dibayar</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="text-sm text-slate-500">Total Klaim Progres (Bruto)</div>
                <div className="text-xl font-bold mt-2">{formatRupiah(summary.totalKlaim)}</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="text-sm text-slate-500">Total Invoice Final (Bruto)</div>
                <div className="text-xl font-bold mt-2">{formatRupiah(summary.totalInvoice)}</div>
              </div>
              <div className="bg-white p-4 rounded-lg shadow flex flex-col justify-between">
                <div>
                  <div className="text-sm text-slate-500">Kontrol</div>
                  <div className="mt-2 flex gap-2">
                    <button onClick={()=>openForm(null)} className="bg-blue-600 text-white px-3 py-1 rounded">+ Tambah</button>
                    <button onClick={()=>{ setClientFilter(''); setProjectFilter(''); setActivityFilter(''); setSearch(''); }} className="bg-slate-100 px-3 py-1 rounded">Reset Filter</button>
                  </div>
                </div>
                <div className="text-xs text-slate-400 mt-2">Data: {transactions.length} item</div>
              </div>
            </section>

            {/* Filters */}
            <section className="mb-6 bg-white p-4 rounded-lg shadow">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                  <label className="text-xs text-slate-600">Klien</label>
                  <select className="w-full p-2 border rounded" value={clientFilter} onChange={e=>setClientFilter(e.target.value)}>
                    <option value=''>Semua Klien</option>
                    {clients.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-600">Nama Proyek</label>
                  <select className="w-full p-2 border rounded" value={projectFilter} onChange={e=>setProjectFilter(e.target.value)}>
                    <option value=''>Semua Proyek</option>
                    {projects.map(p => <option key={p} value={p}>{p}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-600">Kegiatan / Keterangan</label>
                  <select className="w-full p-2 border rounded" value={activityFilter} onChange={e=>setActivityFilter(e.target.value)}>
                    <option value=''>Semua Kegiatan</option>
                    {activities.map(a => <option key={a} value={a}>{a}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-600">Pencarian</label>
                  <input className="w-full p-2 border rounded" placeholder="Cari..." value={search} onChange={e=>setSearch(e.target.value)} />
                </div>
              </div>
            </section>

            {/* Two Tables: Invoice Final & Klaim Progres */}
            <section className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div className="bg-white p-4 rounded-lg shadow">
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-semibold">Outstanding - Invoice Final</h3>
                  <div className="text-sm text-slate-500">{invoiceFinal.length} items</div>
                </div>
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-3 py-2 text-left text-xs">Proyek</th>
                        <th className="px-3 py-2 text-left text-xs">Klien</th>
                        <th className="px-3 py-2 text-left text-xs">Nominal</th>
                        <th className="px-3 py-2 text-left text-xs">Sisa</th>
                        <th className="px-3 py-2 text-left text-xs">Jatuh Tempo</th>
                        <th className="px-3 py-2 text-center text-xs">Aksi</th>
                      </tr>
                    </thead>
                    <tbody>
                      {invoiceFinal.map(tx => {
                        const sisa = Math.max(0, tx.nominal - (tx.amountPaid||0));
                        return (
                          <tr key={tx.id} className="hover:bg-slate-50">
                            <td className="px-3 py-2 text-sm">{tx.proyek}</td>
                            <td className="px-3 py-2 text-sm">{tx.klien}</td>
                            <td className="px-3 py-2 text-sm">{formatRupiah(tx.nominal)}</td>
                            <td className="px-3 py-2 text-sm">{formatRupiah(sisa)}</td>
                            <td className="px-3 py-2 text-sm">{tx.dueDate ? (<div>{tx.dueDate} <div className="text-xs text-slate-400">({daysUntil(tx.dueDate)} hari)</div></div>) : '-'}</td>
                            <td className="px-3 py-2 text-center">
                              <div className="flex justify-center gap-2">
                                <button title="Detail" onClick={()=>openDetail(tx)} className="px-2 py-1 bg-indigo-600 text-white rounded text-xs">Detail</button>
                                <button title="Set Lunas" onClick={()=>requestStatusChange(tx, 'Lunas')} className="px-2 py-1 bg-emerald-600 text-white rounded text-xs">Set Lunas</button>
                              </div>
                            </td>
                          </tr>
                        )
                      })}
                      {invoiceFinal.length===0 && (
                        <tr><td colSpan={6} className="text-center py-6 text-slate-500">Tidak ada data</td></tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>

              <div className="bg-white p-4 rounded-lg shadow">
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-semibold">Klaim Progres</h3>
                  <div className="text-sm text-slate-500">{klaimProgres.length} items</div>
                </div>
                <div className="overflow-x-auto">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="px-3 py-2 text-left text-xs">Proyek</th>
                        <th className="px-3 py-2 text-left text-xs">Klien</th>
                        <th className="px-3 py-2 text-left text-xs">Nominal</th>
                        <th className="px-3 py-2 text-left text-xs">Sisa</th>
                        <th className="px-3 py-2 text-left text-xs">Tanggal</th>
                        <th className="px-3 py-2 text-center text-xs">Aksi</th>
                      </tr>
                    </thead>
                    <tbody>
                      {klaimProgres.map(tx => {
                        const sisa = Math.max(0, tx.nominal - (tx.amountPaid||0));
                        return (
                          <tr key={tx.id} className="hover:bg-slate-50">
                            <td className="px-3 py-2 text-sm">{tx.proyek}</td>
                            <td className="px-3 py-2 text-sm">{tx.klien}</td>
                            <td className="px-3 py-2 text-sm">{formatRupiah(tx.nominal)}</td>
                            <td className="px-3 py-2 text-sm">{formatRupiah(sisa)}</td>
                            <td className="px-3 py-2 text-sm">{tx.tanggal}</td>
                            <td className="px-3 py-2 text-center">
                              <div className="flex justify-center gap-2">
                                <button onClick={()=>openDetail(tx)} className="px-2 py-1 bg-indigo-600 text-white rounded text-xs">Detail</button>
                                <button onClick={()=>requestStatusChange(tx, 'Outstanding')} className="px-2 py-1 bg-amber-500 text-white rounded text-xs">Keep Outstanding</button>
                                <button onClick={()=>requestStatusChange(tx, 'Lunas', true)} className="px-2 py-1 bg-emerald-600 text-white rounded text-xs" title="Convert to Invoice Final & Set Lunas">Convertâ†’Final</button>
                              </div>
                            </td>
                          </tr>
                        )
                      })}
                      {klaimProgres.length===0 && (<tr><td colSpan={6} className="text-center py-6 text-slate-500">Tidak ada data</td></tr>)}
                    </tbody>
                  </table>
                </div>
              </div>
            </section>

            {/* Left: outstanding per project summary */}
            <section className="mb-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div className="bg-white p-4 rounded-lg shadow lg:col-span-1">
                <h4 className="font-semibold mb-2">Outstanding per Proyek & Aktivitas</h4>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {outstandingPerProject.length ? outstandingPerProject.map((it,i)=>(
                    <div key={i} className="flex justify-between items-start p-2 border rounded">
                      <div>
                        <div className="font-medium text-sm">{it.proyek}</div>
                        <div className="text-xs text-slate-500 italic">{it.keterangan}</div>
                      </div>
                      <div className="font-bold text-sm">{formatRupiah(it.totalOutstanding)}</div>
                    </div>
                  )) : <div className="text-sm text-slate-500">Tidak ada outstanding</div>}
                </div>
              </div>

              <div className="bg-white p-4 rounded-lg shadow lg:col-span-2">
                <h4 className="font-semibold mb-2">Ringkasan Klien (Top 5 Outstanding)</h4>
                <div className="space-y-3">
                  {(() => {
                    const map = {};
                    transactions.forEach(t => {
                      const rem = Math.max(0, t.nominal - (t.amountPaid||0));
                      if (rem <= 0) return;
                      map[t.klien] = (map[t.klien]||0) + rem;
                    });
                    const arr = Object.entries(map).map(([klien,total])=>({klien,total})).sort((a,b)=>b.total-a.total).slice(0,5);
                    return arr.length ? arr.map((c,i)=>(
                      <div key={i}>
                        <div className="flex justify-between text-sm font-medium">
                          <div>{c.klien}</div>
                          <div className="text-red-600">{formatRupiah(c.total)}</div>
                        </div>
                        <div className="w-full bg-slate-200 rounded-full h-2.5 mt-1">
                          <div className="bg-red-500 h-2.5 rounded-full" style={{ width: `${(c.total / (arr[0]?.total || 1))*100}%` }}></div>
                        </div>
                      </div>
                    )) : <div className="text-sm text-slate-500">Tidak ada outstanding</div>;
                  })()}
                </div>
              </div>
            </section>

            {/* Detail View */}
            {activeView === 'detail' && detailItem && (
              <section className="fixed inset-0 z-50 flex items-start justify-center p-6 modal-backdrop">
                <div className="bg-white rounded-lg shadow-2xl max-w-3xl w-full p-6 overflow-auto" style={{maxHeight:'90vh'}}>
                  <div className="flex justify-between items-start">
                    <div>
                      <h2 className="text-xl font-bold">{detailItem.proyek}</h2>
                      <div className="text-sm text-slate-500">{detailItem.klien} â€¢ {detailItem.tipe}</div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={()=>{ setActiveView('dashboard'); setDetailItem(null); }} className="px-3 py-1 rounded bg-slate-100">Tutup</button>
                      <button onClick={()=>openForm(detailItem)} className="px-3 py-1 rounded bg-blue-600 text-white">Edit</button>
                      <button onClick={()=>setConfirm({ title:'Hapus Transaksi', message:'Yakin hapus transaksi ini?', onConfirm:()=>deleteTx(detailItem.id), onCancel:()=>setConfirm(null) })} className="px-3 py-1 rounded bg-red-600 text-white">Hapus</button>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div className="space-y-2">
                      <div><span className="text-xs text-slate-500">Nominal</span><div className="font-bold">{formatRupiah(detailItem.nominal)}</div></div>
                      <div><span className="text-xs text-slate-500">Sudah Dibayar</span><div>{formatRupiah(detailItem.amountPaid)}</div></div>
                      <div><span className="text-xs text-slate-500">Sisa</span><div className="font-bold">{formatRupiah(Math.max(0, detailItem.nominal - (detailItem.amountPaid||0)))}</div></div>
                      <div><span className="text-xs text-slate-500">Tanggal Dokumen</span><div>{detailItem.tanggal}</div></div>
                      <div><span className="text-xs text-slate-500">Jatuh Tempo</span><div>{detailItem.dueDate || '-'}</div></div>
                      <div><span className="text-xs text-slate-500">Status</span>
                        <div className="mt-1 flex gap-2">
                          <div className={`px-2 py-1 rounded text-sm ${detailItem.statusPembayaran==='Lunas'?'bg-emerald-100 text-emerald-700': detailItem.statusPembayaran==='Jatuh Tempo'?'bg-red-100 text-red-700':'bg-amber-100 text-amber-700'}`}>{detailItem.statusPembayaran}</div>
                          <button onClick={()=>requestStatusChange(detailItem, 'Lunas')} className="px-2 py-1 bg-emerald-600 text-white rounded text-xs">Set Lunas</button>
                          <button onClick={()=>requestStatusChange(detailItem, 'Outstanding')} className="px-2 py-1 bg-amber-600 text-white rounded text-xs">Set Outstanding</button>
                          {detailItem.tipe !== 'Invoice Final' && <button onClick={()=>requestStatusChange(detailItem, detailItem.statusPembayaran, true)} className="px-2 py-1 bg-indigo-600 text-white rounded text-xs">Convert ke Invoice Final</button>}
                        </div>
                      </div>
                    </div>

                    <div>
                      <div className="mb-2"><span className="text-xs text-slate-500">Keterangan</span><div className="text-sm">{detailItem.keterangan}</div></div>
                      <div className="mb-2">
                        <div className="flex justify-between items-center">
                          <span className="text-sm font-semibold">Riwayat Penagihan</span>
                          <div>
                            <button onClick={()=>openHistoryModal(detailItem,null)} className="px-2 py-1 bg-purple-600 text-white rounded text-xs">Tambah Catatan</button>
                          </div>
                        </div>
                        <div className="mt-2 max-h-48 overflow-y-auto space-y-2">
                          {detailItem.history && detailItem.history.length ? detailItem.history.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).map(h=>(
                            <div key={h.id} className="p-2 border rounded">
                              <div className="flex justify-between">
                                <div className="text-sm">{h.note}</div>
                                <div className="text-xs text-slate-400">{new Date(h.date).toLocaleString()}</div>
                              </div>
                              <div className="mt-1 flex gap-2">
                                {(h.action==='NOTE' || h.action==='REMINDER' || h.action==='SEND') && <button onClick={()=>openHistoryModal(detailItem,h)} className="text-xs text-yellow-600">Edit</button>}
                              </div>
                            </div>
                          )) : <div className="text-sm text-slate-500">Belum ada catatan</div>}
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </section>
            )}

            {/* Form Modal for create/edit */}
            {formOpen && formData && (
              <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-6">
                <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6">
                  <div className="flex justify-between items-center">
                    <h3 className="font-semibold">{formData.id ? 'Edit Transaksi' : 'Tambah Transaksi'}</h3>
                    <div className="flex gap-2">
                      <button onClick={()=>setFormOpen(false)} className="px-2 py-1 rounded bg-slate-100">Batal</button>
                    </div>
                  </div>
                  <form onSubmit={e=>{ e.preventDefault(); saveTransaksi(formData); }}>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                      <div>
                        <label className="text-xs">Tipe</label>
                        <select className="w-full p-2 border rounded" value={formData.tipe} onChange={e=>setFormData({...formData, tipe:e.target.value})}>
                          <option value="Invoice Final">Invoice Final</option>
                          <option value="Klaim Progres">Klaim Progres</option>
                        </select>
                      </div>
                      <div>
                        <label className="text-xs">Tanggal</label>
                        <input type="date" className="w-full p-2 border rounded" value={formData.tanggal} onChange={e=>setFormData({...formData, tanggal:e.target.value})} />
                      </div>
                      <div>
                        <label className="text-xs">Nama Proyek</label>
                        <input className="w-full p-2 border rounded" value={formData.proyek} onChange={e=>setFormData({...formData, proyek:e.target.value})} />
                      </div>
                      <div>
                        <label className="text-xs">Nama Klien</label>
                        <input className="w-full p-2 border rounded" value={formData.klien} onChange={e=>setFormData({...formData, klien:e.target.value})} />
                      </div>
                      <div>
                        <label className="text-xs">Nominal</label>
                        <input className="w-full p-2 border rounded text-right" value={formData.nominal} onChange={e=>setFormData({...formData, nominal: Number(e.target.value||0)})} />
                      </div>
                      <div>
                        <label className="text-xs">Jumlah Terbayar</label>
                        <input className="w-full p-2 border rounded text-right" value={formData.amountPaid} onChange={e=>setFormData({...formData, amountPaid: Number(e.target.value||0)})} />
                      </div>
                      <div>
                        <label className="text-xs">Tanggal Jatuh Tempo (jika Invoice)</label>
                        <input type="date" className="w-full p-2 border rounded" value={formData.dueDate || ''} onChange={e=>setFormData({...formData, dueDate: e.target.value})} />
                      </div>
                      <div className="md:col-span-2">
                        <label className="text-xs">Keterangan</label>
                        <textarea className="w-full p-2 border rounded" value={formData.keterangan} onChange={e=>setFormData({...formData, keterangan:e.target.value})}></textarea>
                      </div>
                    </div>
                    <div className="flex justify-end gap-2 mt-4">
                      <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">{loading ? 'Menyimpan...' : 'Simpan'}</button>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {/* History modal */}
            {historyFormOpen && detailItem && (
              <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-6">
                <div className="bg-white rounded-lg shadow-2xl w-full max-w-md p-6">
                  <div className="flex justify-between items-center">
                    <h3 className="font-semibold">Catatan Penagihan - {detailItem.proyek}</h3>
                    <button onClick={()=>setHistoryFormOpen(false)} className="px-2 py-1 rounded bg-slate-100">Tutup</button>
                  </div>
                  <div className="mt-3">
                    <label className="text-xs">Tipe Aksi</label>
                    <select className="w-full p-2 border rounded" value={historyDraft.action} onChange={e=>setHistoryDraft({...historyDraft, action:e.target.value})}>
                      <option value="NOTE">Catatan</option>
                      <option value="REMINDER">Reminder</option>
                      <option value="PARTIAL_PAYMENT">Pembayaran Parsial</option>
                      <option value="SEND">Kirim Dokumen</option>
                    </select>
                    <label className="text-xs mt-2">Catatan</label>
                    <textarea className="w-full p-2 border rounded" value={historyDraft.note} onChange={e=>setHistoryDraft({...historyDraft, note:e.target.value})}></textarea>
                    <div className="flex justify-end gap-2 mt-3">
                      <button onClick={()=>setHistoryFormOpen(false)} className="px-3 py-1 rounded bg-slate-100">Batal</button>
                      <button onClick={saveHistory} className="px-3 py-1 rounded bg-purple-600 text-white">{loading ? 'Menyimpan...' : 'Simpan Catatan'}</button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Confirmation modal */}
            {confirm && (
              <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-6">
                <div className="bg-white rounded-lg shadow p-6 max-w-md w-full">
                  <h4 className="font-semibold mb-2">{confirm.title}</h4>
                  <p className="text-sm text-slate-600 mb-4">{confirm.message}</p>
                  <div className="flex justify-end gap-2">
                    <button onClick={confirm.onCancel} className="px-3 py-1 rounded bg-slate-100">Batal</button>
                    <button onClick={confirm.onConfirm} className="px-3 py-1 rounded bg-red-600 text-white">Konfirmasi</button>
                  </div>
                </div>
              </div>
            )}

            {/* Error / loading */}
            {(error || loading) && (
              <div className="fixed bottom-4 right-4 bg-white shadow rounded p-3">
                {loading && <div className="flex items-center gap-2"><span className="spinner"></span> Memproses...</div>}
                {error && <div className="text-sm text-red-600">{error}</div>}
              </div>
            )}

          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
